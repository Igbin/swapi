<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" href="main.css" />
</head>
<body>
	<div id="wraper">
		<h1>List planet of star wars</h1>
		<input type="text" name="" id="filter">
	</div>
	<img class="preloader" src="http://zornet.ru/Ajaxoskrip/Fyrkes/Zret/31/Loader-76.gif" alt="preloader">
	<table id="result" border="1" class="main-table"></table>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript">
const URL = 'https://swapi.co/api/planets'
fetch(URL)
.then((response)=> {
return response.json();
 })
   .then((text)=> {
   	const preloader = document.querySelector(".preloader")
   	preloader.style.display = "none";

 	const planetArr = text.results;

	let tr = document.createElement("tr");
	for(key in text.results[0]) {
	var td = document.createElement("td");
	td.innerHTML = key;
	tr.appendChild(td);
	result.appendChild(tr);
	}	
	  	let headLine = document.querySelector('tr').children;
		for(let i =0; i < headLine.length;i++) {
			headLine[i].onclick = mySorting;
			headLine[i].onmouseover = (e) => event.target.classList.add("pointer");
		}
		let  myUpdate = (e) => {
			if(document.querySelector("#result input")) {
			document.querySelector("#result input").parentNode.removeChild(document.querySelector("input"))
			}
			let position;
			for(let i =0; i < event.target.parentNode.children.length;i++) {
				if(event.target.parentNode.children[i].innerHTML === event.target.innerHTML ) {
					position = i
				}
			}
			let objProp = headLine[position].innerHTML;
			let input = document.createElement("input");
			var computedStyle = getComputedStyle(event.target);
			input.style.width = computedStyle.width;
			input.addEventListener("blur", (e) => {
			let data = input.parentNode.getAttribute("data");
			if( !isNaN(parseInt(event.target.parentNode.textContent)) && (isNaN(event.target.value)==true)){
			alert("you must type number value");
			event.target.parentNode.removeChild(event.target)
			return false
		}
			else if(event.target.value !== ""){
			event.target.parentNode.innerHTML = event.target.value + "<br><span style='color:red'>edited</span>";
		} 
		else {
			alert("type some data to change value");
			event.target.parentNode.removeChild(event.target)
			return false
				}
				for(let i=0; i < planetArr.length; i++) {
					for(let key in planetArr[i]) {
						if(planetArr[i].name === data){
							planetArr[i][objProp] = event.target.value + "<br><span style='color:red'>edited</span>";
						}
						}
					}
				})			
			event.target.appendChild(input)
			input.focus()
			}		
		
		let  createTable =  (arr) => {
		arr.forEach((elem,index) =>{
		let tr2 = document.createElement("tr");
		for(key in elem) {
		let td2 = document.createElement("td");
		if(Array.isArray(elem[key])) {
			for(let i=0;i <elem[key].length;i++) {
				td2.innerHTML +=  "" + elem[key][i]
			}
			} else {
			td2.innerHTML = elem[key];
			}
		td2.setAttribute("data", elem.name);
		td2.addEventListener('dblclick', myUpdate);
		tr2.appendChild(td2);
		}
		result.appendChild(tr2)
		})
		   let planets = document.querySelectorAll('tr td:first-child')
		 	for(let i = 1; i< planets.length;i++) {
			planets[i].onmouseenter = (e) => {
				let X = document.createElement("span")
				X.innerHTML = "X";
				X.classList.add("X")
				planets[i].appendChild(X);
				X.onmouseover = (e) => event.target.style.cssText = 'cursor: pointer'; 
				X.onclick = function() {
					if (confirm("Are you sure want to delete this planet?"))
					result.removeChild(this.parentElement.parentElement)
					for(let i =0; i < arr.length; i++) {
						for(let key in arr[i]) {
							if(arr[i][key]=== this.parentElement.textContent.substring(0, this.parentElement.textContent.length-1)) {
								arr.splice(i,1)
							}
						}
					}
				}
				planets[i].onmouseleave = (e) => event.target.removeChild(X)
			}
		}
		}
		createTable(planetArr);

		function mySorting (e) {
				let arrForSorting = [];
				let planets = document.querySelectorAll('tr td:first-child')
		 					for(let i = 1; i< planets.length;i++) {
		 						for(let j = 0; j< planetArr.length;j++) {
		 							for(let key in planetArr[j]) {
		 								if(planets[i].textContent == planetArr[j][key]) {
		 									console.log("somethig")
		 									arrForSorting.push(planetArr[j])
		 								}
		 							}
		 						}
		 						}
				for(let i =0; i < headLine.length;i++) {
				headLine[i].style.backgroundColor = "";}
				event.target.style.backgroundColor = 'green'
				let target = event.target.textContent;
				for(key in planetArr[0]) {
					if(key === target) {
						if(Array.isArray(planetArr[0][key])) {
							let mySortNaNs = (a,b)=> {
							return a[target].localeCompare(b[target])
							}
						}
						else if(parseInt(planetArr[0][key].charAt(0))) {
							let mySortNumbers = (a,b)=> {
								console.log(parseInt(a[target]))
								console.log(parseInt(b[target]))
							return parseInt(a[target]) - parseInt(b[target])
							}
							let table = document.querySelectorAll('tr')
							for(let i =1; i < table.length;i++) {
								result.removeChild(table[i])
							}
							 arrForSorting.sort(mySortNumbers)
							 createTable(arrForSorting)
						} else {
						let mySortNaNs = (a,b)=> {
							return a[target].localeCompare(b[target])
							}
							let table = document.querySelectorAll('tr')
							for(let i =1; i < table.length;i++) {
								result.removeChild(table[i])
							}
							 arrForSorting.sort(mySortNaNs)
								createTable(arrForSorting)
						}
					}
					
				}
					let mesg = document.createElement("h1")
					mesg.setAttribute("id", 'alertMsg')
					mesg.style.cssText = "color:green", "margin-left:200px";
					mesg.innerHTML = ' sorted by ' + target;
					let a = document.getElementById('alertMsg')
					if(a) {
						wraper.removeChild(a)
						wraper.appendChild(mesg)
					} else {
					wraper.appendChild(mesg)
					}
			}

			let filter = document.getElementById("filter");
			filter.addEventListener("keyup", myFilter)
			function myFilter() {
				function isElseforEvery(number) {
 					 return (number.toLowerCase()).indexOf((filter.value).toLowerCase())== -1;
				}
				let arrForfilter = [];
				let planetNames = [];
				for(let i = 0; i <planetArr.length;i++) {
					for(let key in planetArr[i]) {
						if(key == "name"){
							planetNames.push(planetArr[i][key])
							if((planetArr[i][key].toLowerCase()).indexOf((filter.value).toLowerCase())!== -1) {
							arrForfilter.push(planetArr[i]);
							 while (result.childNodes.length != 1) {
   						    result.removeChild(result.lastChild);
   						}
							 createTable(arrForfilter)
					} else if(planetNames.every(isElseforEvery))
						while (result.childNodes.length != 1) {
   						    result.removeChild(result.lastChild);
   						}
					}
				}		
				}
			}
})
.catch(
	error => {
		alert(error)
	})
	
</script>





</body>
</html>